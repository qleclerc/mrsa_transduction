---
title: "phage_play"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(deSolve)
library(dplyr)
library(ggpubr)
library(scales)
library(cowplot)

library(patchwork)
theme_set(theme_bw(base_size = 12))


## Load the lab data: ####
#adjust to what your WD is!!
lab_data4 = read.csv(here::here("Lab", "Transduction", "summary_10_4.csv"), stringsAsFactors = F)
lab_data3 = read.csv(here::here("Lab", "Transduction", "summary_10_3.csv"), stringsAsFactors = F)
lab_data5 = read.csv(here::here("Lab", "Transduction", "summary_10_5.csv"), stringsAsFactors = F)

lab_data_growth = read.csv(here::here("Lab", "Triculture", "summary.csv"), stringsAsFactors = F)

```

## Look at the data

First thing was to look at the data. I wanted to plot with and without log scales, and to look at the three inoculums on top of each other. I've made them all have the same value at time 0 so that they somewhat lie on top of each other. In the below blue -> red -> green for increasing inoculum (3-5). 

```{r data, echo = FALSE}

#3# DATA


brp1 = 3
brp2 = 8
brp3 = 16

p1_log <- ggplot() +
  geom_line(data = lab_data4 %>% filter(Bacteria == "P") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            aes(Time, m_norm, colour = "10^4"), linetype = "dashed") +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data3 %>% filter(Bacteria == "P") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^3")) +
  geom_line(data = lab_data5 %>% filter(Bacteria == "P") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^5")) +
  geom_vline(xintercept = brp1) +
  geom_vline(xintercept = brp2) +
  geom_vline(xintercept = brp3) +
  scale_color_manual(breaks = c("10^3", "10^4", "10^5"),
                     values=c("red", "blue", "green")) +
  ggtitle("Phage")

b1_log <- ggplot() +
  geom_line(data = lab_data4 %>% filter(Bacteria == "Total") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            aes(Time, m_norm, colour = "10^4"), linetype = "dashed") +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data3 %>% filter(Bacteria == "Total") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^3")) +
  geom_line(data = lab_data5 %>% filter(Bacteria == "Total") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^5")) +
  geom_line(data = lab_data_growth %>% filter(Bacteria == "Total") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "No phage")) +
  geom_vline(xintercept = brp1) +
  geom_vline(xintercept = brp2) +
  geom_vline(xintercept = brp3) +
  scale_color_manual(breaks = c("10^3", "10^4", "10^5","No phage"),
                     values=c("red", "blue", "green", "black")) +
  ggtitle("Bacteria")


p1<- ggplot() +
  geom_line(data = lab_data4 %>% filter(Bacteria == "P") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            aes(Time, m_norm, colour = "10^4"), linetype = "dashed") +
  geom_line(data = lab_data3 %>% filter(Bacteria == "P") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^3")) +
  geom_line(data = lab_data5 %>% filter(Bacteria == "P") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^5")) +
  geom_vline(xintercept = brp1) +
  geom_vline(xintercept = brp2) +
  geom_vline(xintercept = brp3) +
  scale_color_manual(breaks = c("10^3", "10^4", "10^5"),
                     values=c("red", "blue", "green")) +
  ggtitle("Phage")

b1 <- ggplot() +
  geom_line(data = lab_data4 %>% filter(Bacteria == "Total") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            aes(Time, m_norm, colour = "10^4"), linetype = "dashed") +
  geom_line(data = lab_data3 %>% filter(Bacteria == "Total") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^3")) +
  geom_line(data = lab_data5 %>% filter(Bacteria == "Total") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^5")) +
  geom_line(data = lab_data_growth %>% filter(Bacteria == "Total") %>% mutate(t0v = 1, m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "No phage")) +
  geom_vline(xintercept = brp1) +
  geom_vline(xintercept = brp2) +
  geom_vline(xintercept = brp3) +
  scale_color_manual(breaks = c("10^3", "10^4", "10^5", "No phage"),
                     values=c("red", "blue", "green", "black")) +
  ggtitle("Bacteria")

ggpubr::ggarrange(b1_log, b1, p1_log, p1,
                  nrow = 2, ncol = 2, common.legend = T, legend = "bottom")

ggsave("comparative_plots.png")

p1_log <- ggplot() +
  geom_line(data = lab_data4 %>% filter(Bacteria == "P") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            aes(Time, m_norm, colour = "10^4"), linetype = "dashed") +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data3 %>% filter(Bacteria == "P") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^3")) +
  geom_line(data = lab_data5 %>% filter(Bacteria == "P") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^5")) +
  geom_vline(xintercept = brp1) +
  geom_vline(xintercept = brp2) +
  geom_vline(xintercept = brp3) +
  scale_color_manual(breaks = c("10^3", "10^4", "10^5"),
                     values=c("red", "blue", "green")) +
  ggtitle("Phage")

b1_log <- ggplot() +
  geom_line(data = lab_data4 %>% filter(Bacteria == "Total") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            aes(Time, m_norm, colour = "10^4"), linetype = "dashed") +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data3 %>% filter(Bacteria == "Total") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^3")) +
  geom_line(data = lab_data5 %>% filter(Bacteria == "Total") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^5")) +
  geom_line(data = lab_data_growth %>% filter(Bacteria == "Total") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "No phage")) +
  geom_vline(xintercept = brp1) +
  geom_vline(xintercept = brp2) +
  geom_vline(xintercept = brp3) +
  scale_color_manual(breaks = c("10^3", "10^4", "10^5","No phage"),
                     values=c("red", "blue", "green", "black")) +
  ggtitle("Bacteria")


p1<- ggplot() +
  geom_line(data = lab_data4 %>% filter(Bacteria == "P") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            aes(Time, m_norm, colour = "10^4"), linetype = "dashed") +
  geom_line(data = lab_data3 %>% filter(Bacteria == "P") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^3")) +
  geom_line(data = lab_data5 %>% filter(Bacteria == "P") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^5")) +
  geom_vline(xintercept = brp1) +
  geom_vline(xintercept = brp2) +
  geom_vline(xintercept = brp3) +
  scale_color_manual(breaks = c("10^3", "10^4", "10^5"),
                     values=c("red", "blue", "green")) +
  ggtitle("Phage")

b1 <- ggplot() +
  geom_line(data = lab_data4 %>% filter(Bacteria == "Total") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            aes(Time, m_norm, colour = "10^4"), linetype = "dashed") +
  geom_line(data = lab_data3 %>% filter(Bacteria == "Total") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^3")) +
  geom_line(data = lab_data5 %>% filter(Bacteria == "Total") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "10^5")) +
  geom_line(data = lab_data_growth %>% filter(Bacteria == "Total") %>% mutate(t0v = Mean[1], m_norm = Mean / t0v),
            linetype = "dashed", aes(Time, m_norm, colour = "No phage")) +
  geom_vline(xintercept = brp1) +
  geom_vline(xintercept = brp2) +
  geom_vline(xintercept = brp3) +
  scale_color_manual(breaks = c("10^3", "10^4", "10^5", "No phage"),
                     values=c("red", "blue", "green", "black")) +
  ggtitle("Bacteria")

ggpubr::ggarrange(b1_log, b1, p1_log, p1,
                  nrow = 2, ncol = 2, common.legend = T, legend = "bottom")

ggsave("comparative_plots_aligned.png")

```


When I do this I think what you can see are three kind of "breakpoints". The first is slow growth by the bacteria, with the second being the end of the growth period. This looks just like exponential growth on a non=log 
non-log scale. What I want to know is whether the bacteria have exactly the same growth (a bit slow and then faster) in the absence of phage? Is the lag time increased by the presence of phage? can you plot them on top of each other? 
I think you'll say they are the same but I'd like to see them together. 

If we then compare to the phage (bottom row), is seems like the phage grow pretty rapidly before the first breakpoint and then slow? Does that seem a fair representation? seems odd / actually not in line with their growth rate not being dependent on replicating bacteria? as in to me looks like they just go for it - could it be that yes it is dependent on reproducing bacteria but that the cumulative effect of this is to result in appararently slow bacterial growth? 

To me they then seem to slow in growth. The first breakpoint doesn't quite work for the phage instead there is some kind of rapid growth then a kink which varies by inoculum size. What is that about? 

After the second breakpoint they all seem pretty steady except 10^6 phage (green). Though this is guess work right? They could all flucutate widely. If we believe the guessed like then there seems to be some kind of equilibrium except slowly increasing phage is killing bacteria at 10^6. Then for all three incoulums I would argue that something happens at 16hrs? what is that? bacteria really totally stop replicating? (if we believe a staight line from 8-16)

Dynamically / mathematically it looks like between the second and third breakpoints they are kind of at an equilbirum with phage and bacteria keeping each other in balance and then there is some stochastic tip off point where this balance no longer holds. As I type though it does seem odd to me that this breakdown happens at a very similar time. OK, but hang on this is due to the data collection. So the fluctuations could happen right back to time 8 right? hmmm Mathematically I was thinking that we basically end up at an unstable equilibrium. Where the slightest deviation kicks them into an almost cycling behaviour though this is overbalanced at 10^6. 

### Models 

I tried to build my own models - they were based more on the mathematics. 

```{r models, echo = FALSE}

#I have a wrapper around the desolve model for simplicity
#parameter "def_model" allows you to choose which model to run
test_model = function(times = seq(0,24,1),
                      params = c(Nmax = 1e9,
                                 mu1 = 1.9,
                                 mu2 = 1.9,
                                 beta = 0.000000001,
                                 L = 10),
                      y = c(B1 = 1e2,
                            B2 = 1e2,
                            P = 1e4),
                      def_model = "mass"){
  
  # if(!(def_model %in% c("mass", "mass_link", "mass_link_burst", "mass_link_both", "frequentist","gwen","gwen2"))){
  #   stop("Function parameter \"def_model\" must be \"mass\", \"mass_link\", \"mass_link_burst\",
  #        \"mass_link_both\" or \"frequentist\"")
  # }
  
  #MASS ACTION
  mass_model = function(times, y, params){
    
    with(as.list(c(y,params)),{
      
      
      N = B1 + B2
      
      
      dB1 = B1 * mu1 * (1 - N/Nmax) - B1 * beta * P   
      dB2 = B2 * mu2 * (1 - N/Nmax) - B2 * beta * P
      dP = N * beta * P * L
      
      
      return(list(c(dB1, dB2,dP)))
      
    }
    )
  }
  
  
  ##MASS ACTION WITH LINK
  mass_link_model = function(times, y, params){
    
    with(as.list(c(y,params)),{
      
      
      N = B1 + B2
      
      beta_t = beta * (1 - N/Nmax)
      
      dB1 = B1 * mu1 * (1 - N/Nmax) - B1 * beta_t * P 
      dB2 = B2 * mu2 * (1 - N/Nmax) - B2 * beta_t * P
      dP = N * beta_t * L * P
      
      
      return(list(c(dB1, dB2,dP)))
      
    }
    )
  }
  
  
  ##MASS ACTION WITH LINK, BURST
  mass_link_burst_model = function(times, y, params){
    
    with(as.list(c(y,params)),{
      
      
      N = B1 + B2
      
      L_t = L * (1 - N/Nmax)
      
      dB1 = B1 * mu1 * (1 - N/Nmax) - B1 * beta * P 
      dB2 = B2 * mu2 * (1 - N/Nmax) - B2 * beta * P
      dP = N * beta * L_t * P
      
      
      return(list(c(dB1, dB2,dP)))
      
    }
    )
  }
  
  
  
  ##MASS ACTION WITH LINK, BOTH
  mass_link_both_model = function(times, y, params){
    
    with(as.list(c(y,params)),{
      
      
      N = B1 + B2
      
      beta_t = beta * (1 - N/Nmax)
      L_t = L * (1 - N/Nmax)
      
      dB1 = B1 * mu1 * (1 - N/Nmax) - B1 * beta_t * P 
      dB2 = B2 * mu2 * (1 - N/Nmax) - B2 * beta_t * P
      dP = N * beta_t * L_t * P
      
      
      return(list(c(dB1, dB2,dP)))
      
    }
    )
  }
  
  
  ##FREQUENTIST MODEL
  frequentist_model = function(times, y, params){
    
    with(as.list(c(y,params)),{
      
      
      N = B1 + B2
      
      beta_t = beta * (1 - N/Nmax)
      L_t = L * (1 - N/Nmax)
      
      P_inf = (1-exp(-beta_t*N)) * P
      B_inf = (1-exp(-P_inf/N)) * N
      
      dB1 = B1 * mu1 * (1 - N/Nmax) - B1/N * B_inf 
      dB2 = B2 * mu2 * (1 - N/Nmax) - B2/N * B_inf 
      dP = B_inf * L_t - P_inf
      
      
      return(list(c(dB1, dB2,dP)))
      
    }
    )
  }
  
  
  gwen_link_both_model = function(times, y, params){
    
    with(as.list(c(y,params)),{
      
      
      N = B1 + B2
      
      beta_t = beta * (1 - N/Nmax)
      
      dB1 = B1 * mu1 * (1 - N/Nmax) - B1 * beta_t * P 
      dB2 = B2 * mu2 * (1 - N/Nmax) - B2 * beta_t * P
      dP = beta_t * L * (P - K) * (P - G*N)
      
      
      return(list(c(dB1, dB2,dP)))
      
    }
    )
  }
  
  gwen2_link_both_model = function(times, y, params){
    
    with(as.list(c(y,params)),{
      
      
      N = B1 + B2
      
      beta_t = beta * (1 - N/Nmax)
      
      dB1 = B1 * mu1 * (1 - N/Nmax) - B1 * beta_t * P 
      dB2 = B2 * mu2 * (1 - N/Nmax) - B2 * beta_t * P
      dP = beta_t * L * (P - K*N) * (P - G*N)
      
      
      return(list(c(dB1, dB2,dP)))
      
    }
    )
  }
  
  
  if(def_model == "mass") {
    res_full = as.data.frame(deSolve::ode(func = mass_model, times = times, y = y, parms = params))
  }
  if(def_model == "mass_link") {
    res_full = as.data.frame(deSolve::ode(func = mass_link_model, times = times, y = y, parms = params))
  }
  if(def_model == "mass_link_burst") {
    res_full = as.data.frame(deSolve::ode(func = mass_link_burst_model, times = times, y = y, parms = params))
  }
  if(def_model == "mass_link_both") {
    res_full = as.data.frame(deSolve::ode(func = mass_link_both_model, times = times, y = y, parms = params))
  }
  if(def_model == "frequentist") {
    res_full = as.data.frame(deSolve::ode(func = frequentist_model, times = times, y = y, parms = params))
  }
  if(def_model == "gwen") {
    res_full = as.data.frame(deSolve::ode(func = gwen_link_both_model, times = times, y = y, parms = params))
  }
  if(def_model == "gwen2") {
    res_full = as.data.frame(deSolve::ode(func = gwen2_link_both_model, times = times, y = y, parms = params))
  }
  
  
  #replace values < 1 by 0, except "times" column ofc
  res_full[,-1][res_full[,-1] < 1] = 0
  
  
  return(res_full)
  
  
}





```

## model 1

At first ("gwen", sorry not very imaginative / correct) I tried to think about how you could have multiple equilibria. If I look at the ratio of teh final bacteria to phage its 10^-4 for 10^3, but 10^-2 for 10^4 / 10^5 right? as in 10^9 bacteria, and then they end up at 105 or 107. This gave me the (P/N - K) * (P/N-G) structure. So here I was thinking of model structure to give two equilibrium (set dp/dt = 0). 


```{r plots, echo = FALSE}
params = c(Nmax = 1e9, #max number of bacteria possible in the system
           mu1 = 1.9, #max growth rate of bacteria 1
           mu2 = 1.8, #max growth rate of bacteria 2
           beta = 0.000000005, #this corresponds to individual phage adsorption rate
           L = 7,#burst size (number of new phage released after infection)
           K = 10^5,
           G = 0.1) 


#which model do you want to run?
#mass, mass_link, mass_link_burst, mass_link_both, or frequentist

model = "gwen"




## RUN ALL MODELS & PLOT ################################

#fixed parameters, no touching!!
#times
times = seq(0,24,0.2)

#initial number of bacteria and phage (matches average from lab data)
yinit = c(B1 = 1e4, 
          B2 = 1e4,
          P = 5e4)

#run model starting phage at 1e4
res4 = test_model(times, params, yinit, def_model = model)

#run model starting phage at 1e3
yinit["P"] = 1.5e3
res3 = test_model(times, params, yinit, def_model = model)

#run model starting phage at 1e5
yinit["P"] = 2e5
res5 = test_model(times, params, yinit, def_model = model)

#plot for Pstart 1e4
pp4 = ggplot(res4) +
  geom_line(aes(time, B1, colour = "EryR")) +
  geom_line(aes(time, B2, colour = "TetR")) +
  geom_line(aes(time, P, colour = "P")) +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data4 %>% filter(Bacteria != "Total"),
            aes(Time, Mean, colour = Bacteria), linetype = "dashed") +
  ggtitle(paste0("10^4,",model)) + 
  theme_bw()

#plot for Pstart 1e3
pp3 = ggplot(res3) +
  geom_line(aes(time, B1, colour = "EryR")) +
  geom_line(aes(time, B2, colour = "TetR")) +
  geom_line(aes(time, P, colour = "P")) +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data3 %>% filter(Bacteria != "Total"),
            aes(Time, Mean, colour = Bacteria), linetype = "dashed") +
  ggtitle(paste0("10^3,",model)) 

#plot for Pstart 1e5
pp5 = ggplot(res5) +
  geom_line(aes(time, B1, colour = "EryR")) +
  geom_line(aes(time, B2, colour = "TetR")) +
  geom_line(aes(time, P, colour = "P")) +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data5 %>% filter(Bacteria != "Total"),
            aes(Time, Mean, colour = Bacteria), linetype = "dashed") +
  ggtitle(paste0("10^5,",model))

#plot all together
# plot_grid(pp3, pp4, pp5,
#           labels = c("10^3", "10^4", "10^5"))

pp3 + pp4 + pp5 + plot_layout(guides = "collect")
```

What's interseting about this is that 
(1) is fits quite well the rapid growth which I know you weren't getting with the other models 
(2) they all go to the 10^5 equilibrium. This is because, in the equations they go to the equilibrium closest to their starting value and here I only really played with K. 



```{r plots2, echo = FALSE}
params = c(Nmax = 1e9, #max number of bacteria possible in the system
           mu1 = 1.9, #max growth rate of bacteria 1
           mu2 = 1.8, #max growth rate of bacteria 2
           beta = 0.000000005, #this corresponds to individual phage adsorption rate
           L = 7,#burst size (number of new phage released after infection)
           K = 10^5,
           G = 10^3) 


#which model do you want to run?
#mass, mass_link, mass_link_burst, mass_link_both, or frequentist

model = "gwen"




## RUN ALL MODELS & PLOT ################################

#fixed parameters, no touching!!
#times
times = seq(0,24,0.2)

#initial number of bacteria and phage (matches average from lab data)
yinit = c(B1 = 1e4, 
          B2 = 1e4,
          P = 5e4)

#run model starting phage at 1e4
res4 = test_model(times, params, yinit, def_model = model)

#run model starting phage at 1e3
yinit["P"] = 1.5e3
res3 = test_model(times, params, yinit, def_model = model)

#run model starting phage at 1e5
yinit["P"] = 2e5
res5 = test_model(times, params, yinit, def_model = model)

#plot for Pstart 1e4
pp4 = ggplot(res4) +
  geom_line(aes(time, B1, colour = "EryR")) +
  geom_line(aes(time, B2, colour = "TetR")) +
  geom_line(aes(time, P, colour = "P")) +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data4 %>% filter(Bacteria != "Total"),
            aes(Time, Mean, colour = Bacteria), linetype = "dashed") +
  ggtitle(paste0("10^4,",model)) + 
  theme_bw()

#plot for Pstart 1e3
pp3 = ggplot(res3) +
  geom_line(aes(time, B1, colour = "EryR")) +
  geom_line(aes(time, B2, colour = "TetR")) +
  geom_line(aes(time, P, colour = "P")) +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data3 %>% filter(Bacteria != "Total"),
            aes(Time, Mean, colour = Bacteria), linetype = "dashed") +
  ggtitle(paste0("10^3,",model)) 

#plot for Pstart 1e5
pp5 = ggplot(res5) +
  geom_line(aes(time, B1, colour = "EryR")) +
  geom_line(aes(time, B2, colour = "TetR")) +
  geom_line(aes(time, P, colour = "P")) +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data5 %>% filter(Bacteria != "Total"),
            aes(Time, Mean, colour = Bacteria), linetype = "dashed") +
  ggtitle(paste0("10^5,",model))

#plot all together
# plot_grid(pp3, pp4, pp5,
#           labels = c("10^3", "10^4", "10^5"))

pp3 + pp4 + pp5 + plot_layout(guides = "collect")
```


If I play with G, all hell goes on with the growth rate, but still end up at 10^5 equilbrium. 

### Model 2

I wasn't happy in gwen1 that there wasn't a dependency on the final P equilibrium on N so added that into the bracket but can't get this to look nicer.... 

```{r cars, echo = FALSE}
params = c(Nmax = 1e9, #max number of bacteria possible in the system
           mu1 = 1.9, #max growth rate of bacteria 1
           mu2 = 1.8, #max growth rate of bacteria 2
           beta = 0.000000005, #this corresponds to individual phage adsorption rate
           L = 7,#burst size (number of new phage released after infection)
           K = 10^5,
           G = 0.1) 


#which model do you want to run?
#mass, mass_link, mass_link_burst, mass_link_both, or frequentist

model = "gwen2"




## RUN ALL MODELS & PLOT ################################

#fixed parameters, no touching!!
#times
times = seq(0,24,0.2)

#initial number of bacteria and phage (matches average from lab data)
yinit = c(B1 = 1e4, 
          B2 = 1e4,
          P = 5e4)

#run model starting phage at 1e4
res4 = test_model(times, params, yinit, def_model = model)

#run model starting phage at 1e3
yinit["P"] = 1.5e3
res3 = test_model(times, params, yinit, def_model = model)

#run model starting phage at 1e5
yinit["P"] = 2e5
res5 = test_model(times, params, yinit, def_model = model)

#plot for Pstart 1e4
pp4 = ggplot(res4) +
  geom_line(aes(time, B1, colour = "EryR")) +
  geom_line(aes(time, B2, colour = "TetR")) +
  geom_line(aes(time, P, colour = "P")) +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data4 %>% filter(Bacteria != "Total"),
            aes(Time, Mean, colour = Bacteria), linetype = "dashed") +
  ggtitle(paste0("10^4,",model)) + 
  theme_bw()

#plot for Pstart 1e3
pp3 = ggplot(res3) +
  geom_line(aes(time, B1, colour = "EryR")) +
  geom_line(aes(time, B2, colour = "TetR")) +
  geom_line(aes(time, P, colour = "P")) +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data3 %>% filter(Bacteria != "Total"),
            aes(Time, Mean, colour = Bacteria), linetype = "dashed") +
  ggtitle(paste0("10^3,",model)) 

#plot for Pstart 1e5
pp5 = ggplot(res5) +
  geom_line(aes(time, B1, colour = "EryR")) +
  geom_line(aes(time, B2, colour = "TetR")) +
  geom_line(aes(time, P, colour = "P")) +
  scale_y_continuous(trans=log10_trans(),
                     breaks=trans_breaks("log10", function(x) 10^x),
                     labels=trans_format("log10", math_format(10^.x))) +
  geom_line(data = lab_data5 %>% filter(Bacteria != "Total"),
            aes(Time, Mean, colour = Bacteria), linetype = "dashed") +
  ggtitle(paste0("10^5,",model))

#plot all together
# plot_grid(pp3, pp4, pp5,
#           labels = c("10^3", "10^4", "10^5"))

pp3 + pp4 + pp5 + plot_layout(guides = "collect")
```

Now they all go to the higher equlibrium... 